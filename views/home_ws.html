<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Filtered HN</title>

    <link href="css/bootstrap-5.3.0-alpha1-min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

    <script src="js/jquery-3.6.0-min.js"></script>
    <script src="js/bootstrap-5.3.0-alpha1-min.js"></script>
    <script src="js/underscore-1.13.1-min.js"></script>
  </head>

  <body bgcolor="#202020">

  <!-- Modal -->
  <div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">

      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Loading Data...</h4>
        </div>
        <div class="modal-body">
            <div id="progress" class="progress">
                <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </div>
      </div>

    </div>
  </div>

    <script id="progress-template" type="text/template">
        <% var percentComplete = parseInt(progress) / 3 * 100; %>
        <% var formatted = (percentComplete / 100).toLocaleString(undefined, {style: 'percent', minimumFractionDigits: 0}) %>
        <% if (percentComplete > 0) { %>
            <div class="progress-bar" role="progressbar" style="width: <%= percentComplete %>%;" aria-valuenow="<%= percentComplete %>" aria-valuemin="0" aria-valuemax="100"><%= formatted %></div>
        <% } %>
    </script>

    <div class="container-fluid" id="data">
    </div>

    <script id="data-template" type="text/template">
        <div class="row">
            <h1>HN filtered</h1>
            <div class="col-md-9 mx-auto">
                <table class="table table-striped table-hover table-sm">
                <% _.each(stories.good, function(story) { %>
                <tr>
                <td><a href="<%= story.comments_link %>" target="_blank"><%= story.comments_num %></a></td>
                <td><span class="score hot" title="Points"><%= story.points %></span></td>
                <td class="title">
                    <a href="<%= story.link %>" class="storylink" target="_blank"><%= story.title %></a>
                    <span class="sitebit comhead">
                        <span class="paren">(</span><span><%= story.host %></span><span class="paren">)</span>
                    </span>
                </td>
                </tr>
                <% }); %>
                </table>
            </div>
        </div>
        <div class="row">
            <h1 data-bs-toggle="collapse" data-bs-target="#crap">HN crap</h1>
            <div class="col-md-9 collapse" id="crap">
                <table class="table table-striped table-hover table-sm">
                <% _.each(stories.crap, function(story) { %>
                <tr class="crap">
                <td class="crap"><a href="<%= story.comments_link %>" target="_blank"><%= story.comments_num %></a></td>
                <td class="crap"><span class="score hot" title="Points"><%= story.points %></span></td>
                <td  class="crap">
                    <a href="<%= story.link %>" class="storylink" target="_blank"><%= story.title %></a>
                    <span class="sitebit comhead">
                        <span class="paren">(</span><span><%= story.host %></span><span class="paren">)</span>
                    </span>
                    <span class="sitebit comhead">
                        <span class="paren">(</span><span><%= story.why %></span><span class="paren">)</span>
                    </span>
                </td>
                </tr>
                <% }); %>
                </table>
            </div>
        </div>
    </script>

      <script>
        $(document).ready(function() {
             $("#myModal").modal("show");

            // Open a WebSocket connection to the Python Bottle app
            var socket = new WebSocket("ws://hollywood.lacoronita:9090/ws");

            console.log("WebSocket connection opened.");

            // Compile the Handlebars templates
            var progressTemplate = _.template($("#progress-template").html());
            var dataTemplate = _.template($("#data-template").html());

            // Handle incoming messages from the WebSocket
            socket.onmessage = function(event) {
                var message = JSON.parse(event.data);
                console.log("Received message: ", message);
                if (message.type == "progress") {
                    // If the message is a progress update, render the progress template
                    console.log("Updating progress bar.");
                    var progress = message.data;
                    var progressHtml = _.template($('#progress-template').html())({progress: progress});
                    $('.progress-bar').remove();
                    $('.progress').append(progressHtml);
                } else if (message.type == "data") {
                    // If the message is data, render the data template
                    console.log("Updating data.");
                    var dataHtml = dataTemplate({ stories: message.data});
                    $("#data").html(dataHtml);
                     $("#myModal").modal("hide");
                }
            };
                    // Handle WebSocket connection errors
            socket.onerror = function(error) {
                console.log("WebSocket connection error: ", error);
            };

            // Handle WebSocket connection close
            socket.onclose = function(event) {
                console.log("WebSocket connection closed with code " + event.code + " and reason " + event.reason);
            };
        });
    </script>
  </body>
</html>
