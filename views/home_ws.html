<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Filtered HN</title>

    <link href="css/bootstrap-5.3.0-alpha1-min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

    <script src="js/jquery-3.6.0-min.js"></script>
    <script src="js/bootstrap-5.3.0-alpha1-min.js"></script>
    <script src="js/underscore-1.13.1-min.js"></script>
    <script src="js/purl.js"></script>
    <script>
        function reload() {
            $("#myModal").modal("show");

            // Open a WebSocket connection to the Python Bottle app
            var loc = window.location.href;
            var hostname = $.url(loc).attr("host");
            var port = $.url(loc).attr("port");
            var ws_url = "ws://" + hostname + ":" + port + "/ws"
            var socket = new WebSocket(ws_url);
            console.log("WebSocket connection opened: " + ws_url);

            // Compile the Handlebars templates
            var progressTemplate = _.template($("#progress-template").html());
            var goodDataTemplate = _.template($("#good-data-template").html());
            var infoTemplate = _.template($("#info-template").html());
            var crapDataTemplate = _.template($("#crap-data-template").html());

            // Handle incoming messages from the WebSocket
            socket.onmessage = function(event) {
                var message = JSON.parse(event.data);
                console.log("Received message: ", message);
                if (message.type == "progress") {
                    // If the message is a progress update, render the progress template
                    console.log("Updating progress bar.");
                    var progress = message.data;
                    var progressHtml = _.template($('#progress-template').html())({progress: progress});
                    $('.progress-bar').remove();
                    $('.progress').append(progressHtml);
                } else if (message.type == "data") {
                    // If the message is data, render the data template
                    console.log("Updating data.");
                    var goodLenHtml = infoTemplate({ info: message.data.gl });
                    $("#good-len").html(goodLenHtml);
                    var crapLenHtml = infoTemplate({ info: message.data.cl });
                    $("#crap-len").html(crapLenHtml);
                    var dataHtml = goodDataTemplate({ stories: message.data.good});
                    $("#good-table tbody").html(dataHtml);

                    var dataHtml = crapDataTemplate({ stories: message.data.crap});
                    $("#crap-table tbody").html(dataHtml);

                    $("#myModal").modal("hide");
                }
            };
                    // Handle WebSocket connection errors
            socket.onerror = function(error) {
                console.log("WebSocket connection error: ", error);
            };

            // Handle WebSocket connection close
            socket.onclose = function(event) {
                console.log("WebSocket connection closed with code " + event.code + " and reason " + event.reason);
            };
            $("#reload-btn").click(function() {
                reload();
            });
        };

    </script>
  </head>

  <body rbgcolor="#202020">

  <nav class="navbar navbar-expand-lg" data-bs-theme="light" style="background-color: #f60;">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <img src="/img/y18.gif" style="border:1px white solid;" width="25" heigth="25"/>
          Filtered HN
      </a>
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item px-3">
            <h1 class="accordion-header" id="headerGood">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGood" aria-expanded="true" aria-controls="collapseOne">
            Good<span id="good-len"></span>
            </button>
            </h1>
          </li>
          <li class="nav-item px-3">
            <h1 class="accordion-header" id="headerCrap">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCrap" aria-expanded="false" aria-controls="collapseOne">
            Crap<span id="crap-len"></span>
            </button>
            </h1>
          </li>
        </ul>
      <div class="d-flex justify-content-end">
        <form class="container-fluid">
          <button id="reload-btn" class="btn btn-danger me-2" type="button">Refresh</button>
        </form>
      </div>
    </div>
  </nav>


  <!-- Modal -->
  <div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">

      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Loading Data...</h4>
        </div>
        <div class="modal-body">
            <div id="progress" class="progress" role="progressbar">
                <div class="progress-bar bg-danger" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </div>
      </div>

    </div>
  </div>

    <script id="progress-template" type="text/template">
        <% var percentComplete = parseInt(progress) / 3 * 100; %>
        <% var formatted = (percentComplete / 100).toLocaleString(undefined, {style: 'percent', minimumFractionDigits: 0}) %>
        <% if (percentComplete > 0) { %>
            <div class="progress-bar bg-danger" style="width: <%= percentComplete %>%;" aria-valuenow="<%= percentComplete %>" aria-valuemin="0" aria-valuemax="100"><%= formatted %></div>
        <% } %>
    </script>

    <div class="accordion" id="data">
      <div class="accordion-item">
        <div class="col-md-9 mx-auto accordion-collapse collapse show" id="collapseGood" aria-labelledby="headerGood" data-bs-parent="#data">
          <div class="accordion-body">
            <table class="table table-striped table-hover table-sm" id="good-table">
            <thead>
              <tr>
                <th>Comments</th>
                <th>Rank</th>
                <th>Link</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <div class="col-md-9 mx-auto accordion-collapse collapse" id="collapseCrap" aria-labelledby="headerCrap" data-bs-parent="#data">
          <div class="accordion-body">
            <table class="table table-striped table-hover table-sm" id="crap-table">
            <thead>
              <tr>
                <th>Comments</th>
                <th>Rank</th>
                <th>Link</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script id="info-template" type="text/template">
        &nbsp;(<%= info %>)
    </script>

    <script id="good-data-template" type="text/template">
                <% _.each(stories, function(story) { %>
                <tr>
                <td><a href="<%= story.comments_link %>" target="_blank"><%= story.comments_num %></a></td>
                <td><span class="score hot" title="Points"><%= story.points %></span></td>
                <td class="title">
                    <a href="<%= story.link %>" class="storylink" target="_blank"><%= story.title %></a>
                    <span class="sitebit comhead">
                        <span class="paren">(</span><span><%= story.host %></span><span class="paren">)</span>
                    </span>
                </td>
                </tr>
                <% }); %>
    </script>

    <script id="crap-data-template" type="text/template">
                <% _.each(stories, function(story) { %>
                <tr class="crap">
                <td class="crap"><a href="<%= story.comments_link %>" target="_blank"><%= story.comments_num %></a></td>
                <td class="crap"><span class="score hot" title="Points"><%= story.points %></span></td>
                <td  class="crap">
                    <a href="<%= story.link %>" class="storylink" target="_blank"><%= story.title %></a>
                    <span class="sitebit comhead">
                        <span class="paren">(</span><span><%= story.host %></span><span class="paren">)</span>
                    </span>
                    <span class="sitebit comhead">
                        <span class="paren">(</span><span><%= story.why %>, line: <%= story.line_num %></span><span class="paren">)</span>
                    </span>
                </td>
                </tr>
                <% }); %>
    </script>


      <script>
        $(document).ready(function() {
            reload();
        });
    </script>
  </body>
</html>
